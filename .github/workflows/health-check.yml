name: Health Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

jobs:
  system-health:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check repository structure
        run: |
          echo "🔍 Checking repository structure..."
          echo ""
          echo "📁 Root directory:"
          ls -la
          echo ""
          echo "📁 Workflows directory:"
          ls -la .github/workflows/
      
      - name: Validate workflow files
        run: |
          echo "✅ Validating workflow YAML files..."
          for file in .github/workflows/*.yml; do
            if [ -f "$file" ]; then
              echo "Checking: $(basename $file)"
              # Basic YAML validation
              if grep -q "name:" "$file" && grep -q "on:" "$file" && grep -q "jobs:" "$file"; then
                echo "✅ $(basename $file) - Valid structure"
              else
                echo "⚠️  $(basename $file) - May have structure issues"
              fi
            fi
          done
      
      - name: Check workflow dependencies
        run: |
          echo "📦 Checking for required dependencies..."
          echo ""
          echo "✅ Git: $(git --version)"
          echo "✅ Python: $(python3 --version 2>/dev/null || echo 'Not available')"
          echo "✅ Node: $(node --version 2>/dev/null || echo 'Not available')"
          echo "✅ Docker: $(docker --version 2>/dev/null || echo 'Not available')"
      
      - name: Analyze workflow status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "📊 Analyzing workflow health..."
          echo ""
          
          # Count workflow files
          WORKFLOW_COUNT=$(ls -1 .github/workflows/*.yml 2>/dev/null | wc -l)
          echo "Total workflow files: $WORKFLOW_COUNT"
          
          # List all workflows
          echo ""
          echo "📋 Registered workflows:"
          for file in .github/workflows/*.yml; do
            if [ -f "$file" ]; then
              workflow_name=$(grep -m 1 "^name:" "$file" | sed 's/name: *//')
              echo "  - $workflow_name ($(basename $file))"
            fi
          done
      
      - name: Test GitHub Actions connectivity
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🔗 Testing GitHub API connectivity..."
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY")
          
          if [ "$response" = "200" ]; then
            echo "✅ GitHub API connection successful"
          else
            echo "⚠️  GitHub API returned status: $response"
          fi
      
      - name: Generate health report
        run: |
          echo "## 🏥 System Health Report" > health-report.md
          echo "Generated: $(date -u)" >> health-report.md
          echo "" >> health-report.md
          
          echo "### Repository Status" >> health-report.md
          echo "- ✅ Repository accessible" >> health-report.md
          echo "- ✅ Workflows directory exists" >> health-report.md
          echo "- ✅ Workflow files detected: $(ls -1 .github/workflows/*.yml 2>/dev/null | wc -l)" >> health-report.md
          echo "" >> health-report.md
          
          echo "### System Components" >> health-report.md
          echo "- ✅ Git: Available" >> health-report.md
          echo "- ✅ GitHub Actions: Running" >> health-report.md
          echo "- ✅ Workflow automation: Active" >> health-report.md
          echo "" >> health-report.md
          
          echo "### Health Status" >> health-report.md
          echo "🟢 All systems operational" >> health-report.md
          
          cat health-report.md
      
      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: health-report
          path: health-report.md
          retention-days: 30
      
      - name: Health check complete
        run: |
          echo "✅ Health check completed successfully"
          echo "🏥 System status: Healthy"
          echo "🔄 Next check: 15 minutes"
